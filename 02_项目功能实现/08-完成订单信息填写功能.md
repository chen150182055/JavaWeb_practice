## 完成订单信息填写功能

  * 首先完成dao层代码的开发：OrderDao将订单信息写入到订单信息表中：

    ```java
    public int addOrder(Order order){
    		String sql="insert into orders values(?,now(),?,?,?,?,?,?,null)";
    		String[] arr={order.getOid(),String.valueOf(order.getTotal()),String.valueOf(order.getState()),
    				order.getAddress(),order.getName(),order.getTelephone(),order.getUid()};
    		int n=0;
    		try {
    			n = qr.update(sql,arr);
    		} catch (SQLException e) {
    			e.printStackTrace();
    		}
    		return n;	
    	}
    ```

* 编写确认订单信息的ConfirmOrderServlet

    ```java
        protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    	    //取出所有提交过来的参数信息
    	    HttpSession session = request.getSession();
        String oid=request.getParameter("oid");
        String address=request.getParameter("address");
        String name=request.getParameter("name");
        String telephone=request.getParameter("telephone");
        
        OrderDao orderDao = new OrderDao();
        OrderItemDao orderItemDao = new OrderItemDao();
        
        User user = (User)session.getAttribute("user");
        
        Order order=new Order();
        order.setOid(oid);
        order.setUid(user.getUid());  //设置购买人信息
        order.setAddress(address);
        order.setName(name);
        order.setTelephone(telephone);
        order.setState(0);
        
        
      //将购物车中的商品都取出来 然后放到订单类中
        List<OrderItem> orderItems = new ArrayList<OrderItem>();
        
        //从hashmap中取出购物车的商品信息
        Cart cart = (Cart) session.getAttribute("cart");
        Set<Entry<String, CartItem>> entry = cart.getCartItems().entrySet();
        
        for (Entry<String, CartItem> cartItem : entry) {
    	OrderItem orderItem = new OrderItem();
    	orderItem.setItemId(UUID.randomUUID().toString());
    	orderItem.setCount(cartItem.getValue().getBuyNum());
    	orderItem.setOid(order.getOid());
    	orderItem.setProduct(cartItem.getValue().getProduct());
    	orderItems.add(orderItem);
    	
    	
        }
        order.setOrderItems(orderItems);
    	orderDao.addOrder(order); //将订单信息写入数据表中  一定要写在后面不然计算不了总价
        //将订单信息填入订单信息表中
        for(OrderItem o : OrderItems){
            orderItemDao.addOrderItem(o);
        }    
        //清除购物车信息
        session.removeAttribute("cart");
        //获取订单中详细的商品信息
        request.setAttribute("order", order);
        request.getRequestDispatcher("account.jsp").forward(request, response);
    }
    ```


* 重写ResultSetHandler中的抽象方法进行联表查询的例子：

  ```java
  /*try {
  		    String sql="select * from OrderItem as o,Product as p where o.oid=? and o.pid=p.pid";
  			list=qr.query(sql,new ResultSetHandler(){
  
  				@Override
  				public List<OrderItem> handle(ResultSet rs) throws SQLException {
  					List<OrderItem> list=new ArrayList<OrderItem>();
  					while(rs.next()){
  						OrderItem orderItem=new OrderItem();
  						orderItem.setItemId(rs.getString(1));
  						orderItem.setCount(rs.getInt(2));
  						Product product=new Product();
  						product.setPid(rs.getString(4));
  						orderItem.setOid(rs.getString(5));
  						product.setPname(rs.getString(7));
  						product.setMarket_price(rs.getDouble(8));
  						product.setShop_price(rs.getDouble(9));
  						product.setPimage(rs.getString(10));
  						product.setPdate(rs.getString(11));
  						product.setIs_hot(rs.getInt(12));
  						product.setPdesc(rs.getString(13));
  						product.setPflag(rs.getInt(14));
  						product.setCid(rs.getString(15));
  						orderItem.setProduct(product);
  						list.add(orderItem);
  					}
  					return list;
  				}}, oid);
  		} catch (SQLException e) {
  			// TODO Auto-generated catch block
  			e.printStackTrace();
  		}*/
  ```

  